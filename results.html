<!DOCTYPE html>
<html lang="mr">
<head>
    <meta charset="UTF-8">
    <title>‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§Ö‡§™‡§°‡•á‡§ü - ‡§Ø‡§∂‡•ã‡§¶‡•Ä‡§™ ‡§ï‡•ç‡§≤‡§æ‡§∏‡•á‡§∏</title>
    <style>
        body { display: flex; font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        .sidebar { width: 250px; background: #2c3e50; color: white; height: 100vh; padding: 20px; position: fixed; }
        .sidebar h2 { color: #3498db; text-align: center; }
        .sidebar a { display: block; color: white; padding: 15px; text-decoration: none; border-bottom: 1px solid #3e4f5f; transition: 0.3s; }
        .sidebar a:hover { background: #34495e; padding-left: 25px; }
        
        .main { margin-left: 280px; padding: 30px; width: calc(100% - 310px); }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        
        .lang-container { position: absolute; top: 20px; right: 25px; }
        .lang-btn { background: #3498db; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer; }

        .filter-section { display: flex; gap: 20px; background: #e8f4fd; padding: 15px; border-radius: 8px; margin-bottom: 20px; align-items: flex-end; }
        .filter-group { flex: 1; }
        label { font-weight: bold; display: block; margin-bottom: 5px; color: #333; }
        select, input { width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #3498db; color: white; }
        
        .mark-input { width: 80px; text-align: center; padding: 8px; border: 1px solid #3498db; border-radius: 4px; }
        .remark-input { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .save-btn { background: #27ae60; color: white; border: none; padding: 12px 25px; border-radius: 5px; cursor: pointer; font-weight: bold; margin-top: 20px; float: right; transition: 0.3s; }
        .save-btn:hover { background: #219150; }
        
        .btn-view { background: #3498db; color: white; border: none; padding: 11px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
        #loader { display: none; color: #e67e22; font-weight: bold; margin-top: 10px; }
        .wa-btn { background: #25D366; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2 id="sideTitle">‡§Ø‡§∂‡•ã‡§¶‡•Ä‡§™ ‡§ï‡•ç‡§≤‡§æ‡§∏‡•á‡§∏</h2>
        <a href="dashboard.html" id="navNewAdm">üìù ‡§®‡§µ‡•Ä‡§® ‡§ç‡§°‡§Æ‡§ø‡§∂‡§®</a>
          <a href="inquiry.html" >üìû ‡§ö‡•å‡§ï‡§∂‡•Ä ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®</a>
        <a href="view-students.html" id="navStudentList">üìã ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§Ø‡§æ‡§¶‡•Ä</a>
        <a href="attendance.html" id="navAttendance">üìÖ ‡§π‡§ú‡•á‡§∞‡•Ä</a>
        <a href="results.html" style="background:#3498db" id="navResults">üìä ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§Ö‡§™‡§°‡•á‡§ü</a>
        <a href="analytics.html" >üìà ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§µ‡§ø‡§∂‡•ç‡§≤‡•á‡§∑‡§£</a>
        <a href="fees.html" id="navFees">üí∞ ‡§´‡•Ä ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°</a>
        <a href="expenses.html" id="navExpenses">üí∏ ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®</a>
        <a href="#" onclick="logout()" id="navLogout">üö™ Log Out</a>
    </div>

    <div class="main">
        <div class="card">
            <div class="lang-container">
                <button class="lang-btn" id="langBtn" onclick="toggleLang()">English</button>
            </div>

            <h2 id="pageTitle" style="color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px;">‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤</h2>
            
            <div class="filter-section">
                <div class="filter-group">
                    <label id="lblClass">‡§µ‡§∞‡•ç‡§ó ‡§®‡§ø‡§µ‡§°‡§æ:</label>
                    <select id="resClass" onchange="updateSubjects()">
                        <option value="" id="optSelect">-- ‡§®‡§ø‡§µ‡§°‡§æ --</option>
                        <option value="5">‡•´ ‡§µ‡•Ä</option><option value="6">‡•¨ ‡§µ‡•Ä</option>
                        <option value="7">‡•≠ ‡§µ‡•Ä</option><option value="8">‡•Æ ‡§µ‡•Ä</option>
                        <option value="9">‡•Ø ‡§µ‡•Ä</option><option value="10">‡•ß‡•¶ ‡§µ‡•Ä</option>
                        <option value="11">‡•ß‡•ß ‡§µ‡•Ä</option><option value="12">‡•ß‡•® ‡§µ‡•Ä</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label id="lblSubject">‡§µ‡§ø‡§∑‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ:</label>
                    <select id="resSubject">
                        <option value="" id="optSubWait">-- ‡§Ü‡§ß‡•Ä ‡§µ‡§∞‡•ç‡§ó ‡§®‡§ø‡§µ‡§°‡§æ --</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label id="lblExam">‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡•á‡§ö‡•á ‡§®‡§æ‡§µ:</label>
                    <select id="examType"></select>
                </div>
                <button class="btn-view" id="btnView" onclick="loadStudentsForMarks()">‡§Ø‡§æ‡§¶‡•Ä ‡§™‡§π‡§æ</button>
            </div>

            <div id="loader">‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á, ‡§ï‡•É‡§™‡§Ø‡§æ ‡§•‡§æ‡§Ç‡§¨‡§æ...</div>

            <div id="studentListContainer" style="display:none;">
                <h3 id="currentSelectionLabel" style="color: #2c3e50; margin-top: 20px;"></h3>
                <table>
                    <thead>
                        <tr>
                            <th>PRN</th>
                            <th id="thName">‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ</th>
                            <th id="thTotal">‡§è‡§ï‡•Ç‡§£ ‡§ó‡•Å‡§£</th>
                            <th id="thObtained">‡§Æ‡§ø‡§≥‡§æ‡§≤‡•á‡§≤‡•á ‡§ó‡•Å‡§£</th>
                            <th id="thRemark">‡§∂‡•á‡§∞‡§æ (Remarks)</th>
                            <th>WhatsApp</th>
                        </tr>
                    </thead>
                    <tbody id="markRows"></tbody>
                </table>
                <button class="save-btn" id="saveMarksBtn" onclick="saveMarks()">‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ (Save)</button>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby4o4KfOU5B_ebeJnUsedovQbofFups_hQWqovzfxk3hz9sz7_DtkCa7kQFXbQOP7YIRQ/exec";
        let currentLang = sessionStorage.getItem("lang") || 'mr';

        const langData = {
            mr: {
                sideTitle: "‡§Ø‡§∂‡•ã‡§¶‡•Ä‡§™ ‡§ï‡•ç‡§≤‡§æ‡§∏‡•á‡§∏", navNewAdm: "üìù ‡§®‡§µ‡•Ä‡§® ‡§ç‡§°‡§Æ‡§ø‡§∂‡§®", navStudentList: "üìã ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§Ø‡§æ‡§¶‡•Ä", navAttendance: "üìÖ ‡§π‡§ú‡•á‡§∞‡•Ä", navFees: "üí∞ ‡§´‡•Ä ‡§∞‡•á‡§ï‡•â‡§∞‡•ç‡§°", navResults: "üìä ‡§®‡§ø‡§ï‡§æ‡§≤/‡§Æ‡§æ‡§∞‡•ç‡§ï", navExpenses: "üí∏ ‡§ñ‡§∞‡•ç‡§ö ‡§µ‡•ç‡§Ø‡§µ‡§∏‡•ç‡§•‡§æ‡§™‡§®", navLogout: "üö™ Log Out",
                pageTitle: "‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•Ä ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§Ö‡§™‡§°‡•á‡§ü ‡§™‡•ã‡§∞‡•ç‡§ü‡§≤", lblClass: "‡§µ‡§∞‡•ç‡§ó ‡§®‡§ø‡§µ‡§°‡§æ:", lblSubject: "‡§µ‡§ø‡§∑‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ:", lblExam: "‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡•á‡§ö‡•á ‡§®‡§æ‡§µ:", optSelect: "-- ‡§®‡§ø‡§µ‡§°‡§æ --", optSubWait: "-- ‡§Ü‡§ß‡•Ä ‡§µ‡§∞‡•ç‡§ó ‡§®‡§ø‡§µ‡§°‡§æ --", btnView: "‡§Ø‡§æ‡§¶‡•Ä ‡§™‡§π‡§æ",
                thName: "‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•ç‡§Ø‡§æ‡§ö‡•á ‡§®‡§æ‡§µ", thTotal: "‡§è‡§ï‡•Ç‡§£ ‡§ó‡•Å‡§£", thObtained: "‡§Æ‡§ø‡§≥‡§æ‡§≤‡•á‡§≤‡•á ‡§ó‡•Å‡§£", thRemark: "‡§∂‡•á‡§∞‡§æ (Remarks)", saveMarksBtn: "‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§∏‡•á‡§µ‡•ç‡§π ‡§ï‡§∞‡§æ (Save)", langBtn: "English",
                loader: "‡§Æ‡§æ‡§π‡§ø‡§§‡•Ä ‡§≤‡•ã‡§° ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á...", alertSelect: "‡§ï‡•É‡§™‡§Ø‡§æ ‡§µ‡§∞‡•ç‡§ó ‡§Ü‡§£‡§ø ‡§µ‡§ø‡§∑‡§Ø ‡§®‡§ø‡§µ‡§°‡§æ!", alertSaved: "‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§Ø‡§∂‡§∏‡•ç‡§µ‡•Ä‡§∞‡§ø‡§§‡•ç‡§Ø‡§æ ‡§∏‡•á‡§µ‡•ç‡§π ‡§ù‡§æ‡§≤‡•á!", confirmWA: "‡§∏‡§∞‡•ç‡§µ ‡§™‡§æ‡§≤‡§ï‡§æ‡§Ç‡§®‡§æ ‡§®‡§ø‡§ï‡§æ‡§≤‡§æ‡§ö‡•á ‡§Æ‡•á‡§∏‡•á‡§ú ‡§™‡§æ‡§†‡§µ‡§æ‡§Ø‡§ö‡•á ‡§ï‡§æ?",
                exams: ["‡§Ø‡•Å‡§®‡§ø‡§ü ‡§ü‡•á‡§∏‡•ç‡§ü ‡•ß", "‡§∏‡§π‡§æ‡§Æ‡§æ‡§π‡•Ä ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ", "‡§Ø‡•Å‡§®‡§ø‡§ü ‡§ü‡•á‡§∏‡•ç‡§ü ‡•®", "‡§µ‡§æ‡§∞‡•ç‡§∑‡§ø‡§ï ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ"],
                addExam: "+ ‡§®‡§µ‡•Ä‡§® ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§ú‡•ã‡§°‡§æ",
                subjects: { basic: ["‡§á‡§Ç‡§ó‡•ç‡§≤‡§ø‡§∂", "‡§ó‡§£‡§ø‡§§", "‡§∏‡§æ‡§Ø‡§®‡•ç‡§∏"], secondary: ["‡§á‡§Ç‡§ó‡•ç‡§≤‡§ø‡§∂", "‡§ó‡§£‡§ø‡§§ ‡•ß", "‡§ó‡§£‡§ø‡§§ ‡•®", "‡§∏‡§æ‡§Ø‡§®‡•ç‡§∏ ‡•ß", "‡§∏‡§æ‡§Ø‡§®‡•ç‡§∏ ‡•®"], higher: ["‡§ó‡§£‡§ø‡§§", "Physics", "Chemistry", "Biology"] },
                waMsg: "*‡§Ø‡§∂‡•ã‡§¶‡•Ä‡§™ ‡§ï‡•ç‡§≤‡§æ‡§∏‡•á‡§∏ - ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡§æ ‡§®‡§ø‡§ï‡§æ‡§≤*%0A%0A‡§®‡§Æ‡§∏‡•ç‡§ï‡§æ‡§∞, ‡§ï‡§≥‡§µ‡§£‡•ç‡§Ø‡§æ‡§§ ‡§Ø‡•á‡§§‡•á ‡§ï‡•Ä ‡§Ü‡§™‡§≤‡§æ ‡§Æ‡•Å‡§≤‡§ó‡§æ/‡§Æ‡•Å‡§≤‡§ó‡•Ä *{name}* ‡§Ø‡§æ‡§ö‡§æ *{exam}* ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡•á‡§ö‡§æ ‡§®‡§ø‡§ï‡§æ‡§≤ ‡§ú‡§æ‡§π‡•Ä‡§∞ ‡§ù‡§æ‡§≤‡§æ ‡§Ü‡§π‡•á.%0A%0A*‡§µ‡§ø‡§∑‡§Ø:* {subject}%0A*‡§Æ‡§ø‡§≥‡§æ‡§≤‡•á‡§≤‡•á ‡§ó‡•Å‡§£:* {obtained} / {total}%0A%0A‡§ß‡§®‡•ç‡§Ø‡§µ‡§æ‡§¶!"
            },
            en: {
                sideTitle: "Yashodeep Classes", navNewAdm: "üìù New Admission", navStudentList: "üìã Student List", navAttendance: "üìÖ Attendance", navResults: "üìä Marks/Results", navFees: "üí∞ Fees Record", navExpenses: "üí∏ Expenses", navLogout: "üö™ Log Out",
                pageTitle: "Student Marks Portal", lblClass: "Select Class:", lblSubject: "Select Subject:", lblExam: "Exam Type:", optSelect: "-- Select --", optSubWait: "-- Select Class First --", btnView: "View List",
                thName: "Student Name", thTotal: "Total Marks", thObtained: "Obtained Marks", thRemark: "Remark", saveMarksBtn: "Save Marks", langBtn: "‡§Æ‡§∞‡§æ‡§†‡•Ä",
                loader: "Loading data, please wait...", alertSelect: "Please select class and subject!", alertSaved: "Marks saved successfully!", confirmWA: "Send result messages to all parents?",
                exams: ["Unit Test 1", "Semester Exam", "Unit Test 2", "Final Exam"],
                addExam: "+ Add New Exam",
                subjects: { basic: ["English", "Maths", "Science"], secondary: ["English", "Maths 1", "Maths 2", "Science 1", "Science 2"], higher: ["Maths", "Physics", "Chemistry", "Biology"] },
                waMsg: "*Yashodeep Classes - Result Update*%0A%0AHello, this is to inform you that the result for *{name}* for the *{exam}* has been declared.%0A%0A*Subject:* {subject}%0A*Marks:* {obtained} / {total}%0A%0AThank you!"
            }
        };
         document.addEventListener("DOMContentLoaded", function() {
            const isLoggedIn = sessionStorage.getItem("isLoggedIn");
            const role = sessionStorage.getItem("userRole");

            if (isLoggedIn !== "true") { window.location.href = "index.html"; return; }

            if (role === "md") {
                const feeLink = document.getElementById("navFees");
                const expLink = document.getElementById("navExpenses");
                if (feeLink) feeLink.style.display = "none";
                if (expLink) expLink.style.display = "none";
            }
            updateLanguageUI();
        });

        document.addEventListener("DOMContentLoaded", function() {
            if (sessionStorage.getItem("isLoggedIn") !== "true") { window.location.href = "index.html"; return; }
            updateLanguageUI();
        });

        function toggleLang() {
            currentLang = (currentLang === 'mr') ? 'en' : 'mr';
            sessionStorage.setItem("lang", currentLang);
            updateLanguageUI();
            updateSubjects();
        }

        function updateLanguageUI() {
            const t = langData[currentLang];
            for (let id in t) {
                const el = document.getElementById(id);
                if (el && typeof t[id] === 'string') el.innerText = t[id];
            }
            const examSelect = document.getElementById('examType');
            examSelect.innerHTML = "";
            t.exams.forEach(ex => {
                let opt = document.createElement("option");
                opt.value = ex; opt.innerText = ex; examSelect.appendChild(opt);
            });
            let addOpt = document.createElement("option");
            addOpt.value = "ADD_NEW"; addOpt.innerText = t.addExam;
            examSelect.appendChild(addOpt);
            examSelect.onchange = function() {
                if (this.value === "ADD_NEW") {
                    let newExam = prompt(currentLang === 'mr' ? "‡§®‡§µ‡•Ä‡§® ‡§™‡§∞‡•Ä‡§ï‡•ç‡§∑‡•á‡§ö‡•á ‡§®‡§æ‡§µ ‡§ü‡§æ‡§ï‡§æ:" : "Enter New Exam Name:");
                    if (newExam) {
                        let opt = document.createElement("option");
                        opt.value = newExam; opt.innerText = newExam;
                        examSelect.insertBefore(opt, examSelect.lastChild);
                        examSelect.value = newExam;
                    } else { examSelect.selectedIndex = 0; }
                }
            };
        }

        function updateSubjects() {
            let c = document.getElementById('resClass').value;
            let s = document.getElementById('resSubject');
            const t = langData[currentLang];
            s.innerHTML = "";
            if(!c) { s.innerHTML = `<option value=''>${t.optSubWait}</option>`; return; }
            let subs = [];
            if(["5", "6", "7", "8"].includes(c)) subs = t.subjects.basic;
            else if(["9", "10"].includes(c)) subs = t.subjects.secondary;
            else if(["11", "12"].includes(c)) subs = t.subjects.higher;
            subs.forEach(sub => {
                let opt = document.createElement("option");
                opt.value = sub; opt.innerText = sub; s.appendChild(opt);
            });
        }

        async function loadStudentsForMarks() {
            const t = langData[currentLang];
            const className = document.getElementById('resClass').value;
            const subject = document.getElementById('resSubject').value;
            const exam = document.getElementById('examType').value;
            if (!className || !subject) { alert(t.alertSelect); return; }
            const loader = document.getElementById('loader');
            loader.style.display = "block";
            document.getElementById('studentListContainer').style.display = "none";
            try {
                const response = await fetch(`${SCRIPT_URL}?action=read&className=Class ${className}`);
                const data = await response.json();
                const tbody = document.getElementById('markRows');
                tbody.innerHTML = "";
                data.forEach(student => {
                    const tr = document.createElement('tr');
                    tr.setAttribute('data-phone', student.parentPhone || "");
                    tr.innerHTML = `
                        <td>${student.prn}</td>
                        <td class="st-name">${student.name}</td>
                        <td><input type="number" class="mark-total" value="100" style="width:60px; text-align:center;" oninput="updateAutoRemark(this)"></td>
                        <td><input type="number" class="mark-obtained" placeholder="0" style="width:60px; text-align:center;" oninput="updateAutoRemark(this)"></td>
                        <td><input type="text" class="remark-input" placeholder="..." style="font-weight:bold;"></td>
                        <td><button class="wa-btn" onclick="sendResultWhatsApp(this)">üì≤</button></td>
                    `;
                    tbody.appendChild(tr);
                });
                document.getElementById('currentSelectionLabel').innerText = `${className} | ${subject} | ${exam}`;
                document.getElementById('studentListContainer').style.display = "block";
            } catch (error) { 
                console.error(error);
                alert("Error loading students!"); 
            } finally { loader.style.display = "none"; }
        }

        function updateAutoRemark(input) {
            const row = input.closest('tr');
            const obtained = parseFloat(row.querySelector('.mark-obtained').value);
            const total = parseFloat(row.querySelector('.mark-total').value);
            const remarkField = row.querySelector('.remark-input');
            const nameField = row.querySelector('.st-name');
            if (isNaN(obtained) || isNaN(total) || total === 0) return;
            const percentage = (obtained / total) * 100;
            if (percentage >= 80) {
                remarkField.value = (currentLang === 'mr' ? "‡§â‡§§‡•ç‡§ï‡•É‡§∑‡•ç‡§ü!" : "Excellent!");
                remarkField.style.color = "green";
            } else if (percentage >= 60) {
                remarkField.value = (currentLang === 'mr' ? "‡§õ‡§æ‡§®" : "Good");
                remarkField.style.color = "blue";
            } else if (percentage >= 35) {
                remarkField.value = (currentLang === 'mr' ? "‡§∏‡•Å‡§ß‡§æ‡§∞‡§£‡§æ ‡§π‡§µ‡•Ä" : "Average");
                remarkField.style.color = "orange";
            } else {
                remarkField.value = (currentLang === 'mr' ? "‡§ñ‡•Ç‡§™ ‡§™‡•ç‡§∞‡§Ø‡§§‡•ç‡§® ‡§π‡§µ‡•á‡§§" : "Need Hard Work");
                remarkField.style.color = "red";
            }
            if (percentage < 35) {
                nameField.style.color = "red";
                nameField.style.fontWeight = "bold";
            } else {
                nameField.style.color = "black";
                nameField.style.fontWeight = "normal";
            }
        }

        function sendResultWhatsApp(btn) {
            const t = langData[currentLang];
            const row = btn.closest('tr');
            const name = row.querySelector('.st-name').innerText;
            const phone = row.getAttribute('data-phone');
            const total = row.querySelector('.mark-total').value;
            const obtained = row.querySelector('.mark-obtained').value;
            const subject = document.getElementById('resSubject').value;
            const exam = document.getElementById('examType').value;
            if(!obtained) return;
            let message = t.waMsg.replace("{name}", name).replace("{exam}", exam).replace("{subject}", subject).replace("{obtained}", obtained).replace("{total}", total);
            let cleanPhone = phone.toString().replace(/\D/g, '');
            if (cleanPhone.length === 10) cleanPhone = "91" + cleanPhone;
            window.open(`https://wa.me/${cleanPhone}?text=${message}`, '_blank');
        }

        function saveMarks() {
            const t = langData[currentLang];
            const btn = document.getElementById('saveMarksBtn');
            const rows = document.querySelectorAll('#markRows tr');
            let marksData = [];
            rows.forEach(row => {
                const obtainedValue = row.querySelector('.mark-obtained').value;
                if (obtainedValue !== "") {
                    marksData.push({
                        prn: row.cells[0].innerText, 
                        name: row.querySelector('.st-name').innerText,
                        total: row.querySelector('.mark-total').value, 
                        obtained: obtainedValue,
                        remark: row.querySelector('.remark-input').value
                    });
                }
            });
            if (marksData.length === 0) {
                alert(currentLang === 'mr' ? "‡§ï‡•É‡§™‡§Ø‡§æ ‡§ï‡§ø‡§Æ‡§æ‡§® ‡§è‡§ï‡§æ ‡§µ‡§ø‡§¶‡•ç‡§Ø‡§æ‡§∞‡•ç‡§•‡•ç‡§Ø‡§æ‡§ö‡•á ‡§Æ‡§æ‡§∞‡•ç‡§ï ‡§≠‡§∞‡§æ!" : "Please enter marks for at least one student!");
                return;
            }
            btn.disabled = true;
            btn.innerText = (currentLang === 'mr' ? "‡§∏‡•á‡§µ‡•ç‡§π ‡§π‡•ã‡§§ ‡§Ü‡§π‡•á..." : "Saving...");
            fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                cache: 'no-cache',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    type: "MarksUpdate", 
                    className: "Class " + document.getElementById('resClass').value, 
                    subject: document.getElementById('resSubject').value, 
                    exam: document.getElementById('examType').value, 
                    records: marksData 
                })
            })
            .then(() => {
                alert(t.alertSaved);
                if(confirm(t.confirmWA)) {
                    document.querySelectorAll('.wa-btn').forEach((b, idx) => {
                        const row = b.closest('tr');
                        const ob = row.querySelector('.mark-obtained').value;
                        if(ob !== "") { setTimeout(() => sendResultWhatsApp(b), idx * 1500); }
                    });
                }
            })
            .catch(err => alert("Error saving: " + err))
            .finally(() => { 
                btn.disabled = false; 
                btn.innerText = t.saveMarksBtn; 
            });
        }

        function logout() { sessionStorage.clear(); window.location.href = "index.html"; }
        // --- Keyboard Navigation Script Starts ---
document.addEventListener('keydown', function(e) {
    const active = document.activeElement;
    // ‡§´‡§ï‡•ç‡§§ Input, Select, Textarea ‡§Ü‡§£‡§ø Button ‡§µ‡§∞‡§ö ‡§π‡•á ‡§ï‡§æ‡§Æ ‡§ï‡§∞‡•á‡§≤
    if (!['INPUT', 'SELECT', 'TEXTAREA', 'BUTTON'].includes(active.tagName)) return;

    // ‡§´‡•â‡§∞‡•ç‡§Æ ‡§Æ‡§ß‡•Ä‡§≤ ‡§∏‡§∞‡•ç‡§µ ‡§ò‡§ü‡§ï‡§æ‡§Ç‡§ö‡•Ä ‡§Ø‡§æ‡§¶‡•Ä (‡§∏‡•ç‡§ï‡§ø‡§™ ‡§® ‡§ï‡§∞‡§§‡§æ)
    const focusableEls = Array.from(document.querySelectorAll('input, select, textarea, button:not(.lang-btn)'));
    const index = focusableEls.indexOf(active);

    switch(e.key) {
        case 'ArrowDown':
            e.preventDefault();
            if (index + 2 < focusableEls.length) focusableEls[index + 2].focus(); // ‡§ó‡•ç‡§∞‡§ø‡§°‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ñ‡§æ‡§≤‡•Ä ‡§ú‡§æ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä
            else if (index + 1 < focusableEls.length) focusableEls[index + 1].focus();
            break;
            
        case 'ArrowUp':
            e.preventDefault();
            if (index - 2 >= 0) focusableEls[index - 2].focus(); // ‡§ó‡•ç‡§∞‡§ø‡§°‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§µ‡§∞ ‡§ú‡§æ‡§£‡•ç‡§Ø‡§æ‡§∏‡§æ‡§†‡•Ä
            else if (index - 1 >= 0) focusableEls[index - 1].focus();
            break;
            
        case 'ArrowRight':
            e.preventDefault();
            if (index + 1 < focusableEls.length) focusableEls[index + 1].focus();
            break;
            
        case 'ArrowLeft':
            e.preventDefault();
            if (index - 1 >= 0) focusableEls[index - 1].focus();
            break;

        case 'Enter':
            // ‡§ú‡§∞ ‡§¨‡§ü‡§£ ‡§Ö‡§∏‡•á‡§≤ ‡§§‡§∞ ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§π‡•ã‡§à‡§≤, ‡§Ö‡§®‡•ç‡§Ø‡§•‡§æ ‡§™‡•Å‡§¢‡§ö‡•ç‡§Ø‡§æ ‡§¨‡•â‡§ï‡•ç‡§∏‡§Æ‡§ß‡•ç‡§Ø‡•á ‡§ú‡§æ‡§à‡§≤
            if (active.tagName !== 'BUTTON' && active.tagName !== 'TEXTAREA') {
                e.preventDefault();
                if (index + 1 < focusableEls.length) focusableEls[index + 1].focus();
            }
            break;
    }
});
// --- Keyboard Navigation Script Ends ---
    </script>
</body>
</html>